# Unified User Creation System

## Overview

Admins can now create users via CMS and select their role. The system handles different flows based on the selected role.

## Endpoint

**POST `/admin/users/create`**

**Access:** Admin only (requires admin JWT token)

**Request Body:**
```json
{
  "firstName": "John",
  "lastName": "Doe",
  "email": "john@example.com",
  "phone": "+27123456789",
  "role": "admin" | "customer" | "service_provider"
}
```

## Role-Based Flows

### 1. Admin Role

**What Happens:**
- âœ… Auto-generated secure password (12 characters)
- âœ… Password hashed and stored
- âœ… Admin verification record created
- âœ… Email sent with credentials:
  - Email address (username)
  - Auto-generated password
  - Instructions to change password after first login

**Email Content:**
- Subject: "Your SPANA Admin Account Credentials ğŸ”"
- Contains: Email and password
- Warning: Change password after first login

**Response:**
```json
{
  "message": "Admin created successfully.",
  "user": { ... },
  "password": "AutoGenerated123!",
  "note": "Password sent via email. User should change password after first login."
}
```

### 2. Customer Role

**What Happens:**
- âœ… Auto-generated secure password (12 characters)
- âœ… Password hashed and stored
- âœ… Customer record created
- âœ… Email sent with credentials:
  - Email address (username)
  - Auto-generated password
  - Instructions to change password after first login

**Email Content:**
- Subject: "Welcome to SPANA! Your Account Details ğŸ‰"
- Contains: Email and password
- Welcome message

**Response:**
```json
{
  "message": "Customer created successfully.",
  "user": { ... },
  "password": "AutoGenerated123!",
  "note": "Password sent via email. User should change password after first login."
}
```

### 3. Service Provider Role

**What Happens:**
- âœ… Placeholder password (user sets their own)
- âœ… Service provider record created
- âœ… Verification token generated
- âœ… Email sent with profile completion link
- âŒ No password in email (user sets it on form)

**Email Content:**
- Subject: "Welcome to SPANA, [Name]! ğŸ‰"
- Contains: Profile completion link
- User sets password on completion form

**Response:**
```json
{
  "message": "Service provider created successfully.",
  "user": { ... },
  "profileCompletionLink": "https://.../complete-registration?token=...&uid=..."
}
```

## Admin Profile Management

**PUT `/admin/profile`**

**Access:** Admin only (updates their own profile)

**Request Body:**
```json
{
  "password": "NewPassword123!",
  "firstName": "Updated",
  "lastName": "Name",
  "phone": "+27123456789"
}
```

**Response:**
```json
{
  "message": "Profile updated successfully",
  "user": {
    "id": "...",
    "email": "...",
    "firstName": "...",
    "lastName": "...",
    "phone": "...",
    "role": "admin",
    ...
  }
}
```

## Password Generation

- **Length:** 12 characters
- **Characters:** Letters (upper/lower), numbers, special chars (!@#$%^&*)
- **Security:** Cryptographically random
- **Storage:** Hashed with bcrypt (12 rounds)

## Email Templates

### Admin Credentials Email
- Professional design
- Clear credentials display
- Security warning
- Instructions to change password

### Customer Welcome Email
- Welcome message
- Credentials display
- Security warning
- Getting started info

### Service Provider Welcome Email
- Welcome message
- Profile completion link
- Instructions to complete profile

## Security Features

1. **Password Requirements:**
   - Minimum 8 characters for manual changes
   - Auto-generated: 12 characters with mixed case, numbers, special chars

2. **Email Domain Validation:**
   - Admin emails must be from `ADMIN_EMAIL_DOMAINS`
   - Default: `@spana.co.za`, `@gmail.com`

3. **Password Change:**
   - Admins can change password via `/admin/profile`
   - Password must be at least 8 characters

## Flow Diagram

```
Admin Creates User
    â†“
Select Role
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Admin Role                          â”‚
â”‚ â†’ Generate Password                 â”‚
â”‚ â†’ Send Credentials Email            â”‚
â”‚ â†’ User logs in with credentials     â”‚
â”‚ â†’ User changes password             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Customer Role                       â”‚
â”‚ â†’ Generate Password                 â”‚
â”‚ â†’ Send Welcome Email                â”‚
â”‚ â†’ User logs in with credentials     â”‚
â”‚ â†’ User changes password             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service Provider Role                â”‚
â”‚ â†’ No Password (placeholder)         â”‚
â”‚ â†’ Send Profile Completion Link      â”‚
â”‚ â†’ User completes profile            â”‚
â”‚ â†’ User sets their own password      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Benefits

- âœ… **Unified Interface:** One endpoint for all user types
- âœ… **Role Selection:** Admin chooses role explicitly
- âœ… **Secure Passwords:** Auto-generated strong passwords
- âœ… **Email Delivery:** Credentials sent securely via email
- âœ… **Flexible:** Different flows for different roles
- âœ… **User-Friendly:** Clear instructions in emails

## Testing

```bash
# Test unified user creation
node scripts/test-create-user.js
```

## Next Steps

1. Restore full `adminController.ts` from git
2. Add `createUser` and `updateAdminProfile` functions
3. Test each role flow
4. Verify emails are sent correctly
